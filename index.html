// Updated Buy Logic: Cap of 100 per individual orb type
    window.buyOrb = async (id, cost) => {
        if(!userData) return;
        
        // Check the count of the specific orb being purchased
        const specificOrbOwned = userData.orbs?.[id] || 0;
        
        if (specificOrbOwned >= 100) {
            alert(`You already have the maximum amount (100) of this specific orb!`);
            return;
        }

        if(userData.balance < cost) return;

        await updateDoc(doc(db, "users", auth.currentUser.uid), { 
            balance: increment(-cost), 
            [`orbs.${id}`]: increment(1) 
        });
    };

    // Updated renderOrbs logic for individual "MAX" badges
    function renderOrbs(gridId, dataList) {
        if (!userData) return;
        const grid = document.getElementById(gridId);
        grid.innerHTML = '';

        dataList.forEach((orb, index) => {
            const owned = userData.orbs?.[orb.id] || 0;
            const isUnlocked = index === 0 || (userData.orbs?.[dataList[index-1].id] > 0);
            const cost = Math.floor(orb.baseCost * Math.pow(1.3, owned));
            const sellPrice = Math.floor(cost * 0.7);
            const isSpecificMaxed = owned >= 100; // Check only this orb type
            
            const div = document.createElement('div');
            div.className = 'orb-item';
            
            div.innerHTML = `
                ${isUnlocked ? `
                <div class="orb-stats-top">
                    ${owned > 0 ? `<button onclick="sellOrb('${orb.id}', ${sellPrice})" class="sell-btn">SELL</button>` : ''}
                    <div class="owned-badge" style="${isSpecificMaxed ? 'border-color: #ef4444; color: #ef4444;' : ''}">
                        ${isSpecificMaxed ? 'MAX' : 'x' + owned}
                    </div>
                </div>
                ` : ''}
                <div class="orb-visual" style="color:${orb.color}; background:currentColor"></div>
                <b>${orb.name}</b>
                ${isUnlocked ? `
                    <div style="font-size:10px; margin:5px 0;">
                        <span style="color:#10b981">+$${calcIncome(orb, owned).toLocaleString()}</span>
                        <br><span style="color:#94a3b8">Every ${orb.time/1000}s</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" id="bar-${orb.id}"></div></div>
                ` : ''}
                <button onclick="buyOrb('${orb.id}', ${cost})" class="buy-btn ${userData.balance >= cost && isUnlocked && !isSpecificMaxed ? 'btn-available' : 'btn-locked'}">
                    ${isUnlocked ? `Upgrade $${cost.toLocaleString()}` : 'LOCKED'}
                </button>
            `;
            // ... (rest of render logic)
            grid.appendChild(div);
        });
    }
