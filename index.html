<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailCash - Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ecf0f1;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .auth-card, .app-container { 
            background: #2c3e50;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid #34495e;
        }
        .auth-card { max-width: 400px; margin: 50px auto; }
        h1 { color: #3498db; margin-bottom: 10px; font-size: 28px; }
        h2 { color: #ecf0f1; margin-bottom: 20px; font-size: 22px; }
        .subtitle { color: #95a5a6; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #bdc3c7; }
        input, textarea, select { 
            width: 100%;
            padding: 12px;
            border: 2px solid #34495e;
            border-radius: 8px;
            background: #34495e;
            color: #ecf0f1;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        button { 
            padding: 14px 24px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); }
        .link-btn { background: none; color: #3498db; text-decoration: underline; font-size: 14px; }
        .hidden { display: none; }
        .header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #34495e;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .balance { 
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 18px;
        }
        .tabs { 
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #34495e;
            overflow-x: auto;
            flex-wrap: wrap;
        }
        .tab { 
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #95a5a6;
            transition: all 0.3s;
        }
        .tab:hover { color: #ecf0f1; }
        .tab.active { border-bottom-color: #3498db; color: #3498db; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Inbox Styles */
        .inbox-container { display: flex; gap: 20px; height: 600px; }
        .message-list { flex: 1; overflow-y: auto; border-right: 2px solid #34495e; padding-right: 20px; }
        .message-preview { 
            padding: 15px;
            border: 1px solid #34495e;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: #34495e;
        }
        .message-preview:hover { background: #3d5467; border-color: #3498db; }
        .message-preview.selected { background: #3d5467; border-color: #3498db; }
        .message-detail { flex: 1.5; background: #34495e; padding: 30px; border-radius: 8px; overflow-y: auto; }
        .message-detail-empty { display: flex; align-items: center; justify-content: center; color: #7f8c8d; }
        .message-from { font-weight: 600; color: #3498db; margin-bottom: 5px; }
        .message-subject { font-weight: 600; color: #ecf0f1; margin-bottom: 5px; }
        .message-body { color: #bdc3c7; font-size: 14px; }
        .message-date { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        
        .transaction-item { 
            padding: 15px;
            border: 1px solid #34495e;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #34495e;
        }
        .transaction-header { display: flex; justify-content: space-between; align-items: center; }
        .transaction-type { font-weight: 600; color: #ecf0f1; }
        .transaction-date { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .transaction-amount { font-size: 18px; font-weight: bold; }
        .received { color: #27ae60; }
        .sent { color: #e74c3c; }
        
        /* Stock Market */
        .stocks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stock-card { 
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #34495e;
            transition: all 0.3s;
        }
        .stock-card:hover { border-color: #3498db; }
        .stock-name { font-size: 20px; font-weight: 600; color: #ecf0f1; margin-bottom: 10px; }
        .stock-price { font-size: 24px; font-weight: bold; color: #3498db; margin-bottom: 5px; }
        .stock-change { font-size: 14px; margin-bottom: 15px; }
        .stock-change.positive { color: #27ae60; }
        .stock-change.negative { color: #e74c3c; }
        .stock-actions { display: flex; gap: 10px; }
        .stock-actions input { width: 80px; }
        .stock-actions button { margin: 0; padding: 8px 16px; }
        
        .portfolio { background: #34495e; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .portfolio-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #2c3e50; }
        
        /* Casino */
        .casino-games { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .game-card { background: #34495e; padding: 30px; border-radius: 8px; text-align: center; }
        .game-title { font-size: 24px; font-weight: 600; margin-bottom: 20px; color: #3498db; }
        .bet-input { width: 150px; margin: 15px auto; display: block; }
        .roulette-wheel { 
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(#e74c3c 0deg 45deg, #2c3e50 45deg 90deg, #e74c3c 90deg 135deg, #2c3e50 135deg 180deg, #e74c3c 180deg 225deg, #2c3e50 225deg 270deg, #e74c3c 270deg 315deg, #2c3e50 315deg 360deg);
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 5px solid #f39c12;
        }
        .roulette-result { 
            background: white;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        .blackjack-cards { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .card { 
            width: 60px;
            height: 90px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            border: 2px solid #34495e;
        }
        .coin { 
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #f39c12;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: #2c3e50;
            border: 5px solid #d68910;
        }
        .game-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .game-buttons button { margin: 0; }
        
        .empty-state { text-align: center; color: #7f8c8d; padding: 40px; }
        
        @media (max-width: 768px) {
            .inbox-container { flex-direction: column; height: auto; }
            .message-list { border-right: none; border-bottom: 2px solid #34495e; padding-bottom: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginScreen" class="auth-card">
            <h1>MailCash</h1>
            <p class="subtitle">Login to your account</p>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="demo@mail.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword">
            </div>
            <button onclick="login()">Login</button>
            <button class="link-btn" onclick="showRegister()">New here? Register</button>
        </div>

        <div id="registerScreen" class="auth-card hidden">
            <h1>Join MailCash</h1>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="regName">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="regEmail">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="regPassword">
            </div>
            <button onclick="register()">Create Account</button>
            <button class="link-btn" onclick="showLogin()">Back to Login</button>
        </div>

        <div id="appScreen" class="app-container hidden">
            <div class="header">
                <h1>MailCash</h1>
                <div style="display:flex; align-items:center; gap:15px; flex-wrap: wrap;">
                    <div class="balance">$<span id="userBalance">0.00</span></div>
                    <span id="userNameDisplay" style="color: #bdc3c7;"></span>
                    <button onclick="logout()" style="background: #e74c3c; padding: 8px 15px;">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('inbox')">Inbox</div>
                <div class="tab" onclick="switchTab('compose')">Compose</div>
                <div class="tab" onclick="switchTab('transfer')">Send Money</div>
                <div class="tab" onclick="switchTab('transactions')">History</div>
                <div class="tab" onclick="switchTab('stocks')">Stock Market</div>
                <div class="tab" onclick="switchTab('casino')">Casino</div>
            </div>

            <div id="inboxTab" class="tab-content active">
                <div class="inbox-container">
                    <div class="message-list" id="messageList">
                        <div class="empty-state">Loading messages...</div>
                    </div>
                    <div class="message-detail" id="messageDetail">
                        <div class="message-detail-empty">Select a message to read</div>
                    </div>
                </div>
            </div>

            <div id="composeTab" class="tab-content">
                <h2>Compose Email</h2>
                <input type="email" id="emailTo" placeholder="Recipient Email" style="margin-bottom:10px">
                <input type="text" id="emailSubject" placeholder="Subject" style="margin-bottom:10px">
                <textarea id="emailBody" rows="5" placeholder="Message" style="margin-bottom:10px"></textarea>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="includeMoney" onchange="toggleMoneyInput()">
                    <label for="includeMoney" style="margin: 0;">Include money transfer</label>
                </div>
                <input type="number" id="emailMoney" placeholder="Amount ($)" style="margin-bottom:10px; display:none;">
                <button onclick="sendEmail()">Send Message</button>
            </div>

            <div id="transferTab" class="tab-content">
                <h2>Send Money</h2>
                <input type="email" id="transferTo" placeholder="Recipient Email" style="margin-bottom:10px">
                <input type="number" id="transferAmount" placeholder="0.00" style="margin-bottom:10px">
                <textarea id="transferMessage" rows="3" placeholder="Optional message" style="margin-bottom:10px"></textarea>
                <button onclick="sendMoney()">Transfer Funds</button>
            </div>

            <div id="transactionsTab" class="tab-content">
                <h2>Transaction History</h2>
                <div id="transactionsList"></div>
            </div>

            <div id="stocksTab" class="tab-content">
                <h2>Stock Market</h2>
                <div class="portfolio" id="portfolio">
                    <h3 style="margin-bottom: 15px;">Your Portfolio</h3>
                    <div id="portfolioList"></div>
                </div>
                <div class="stocks-grid" id="stocksGrid"></div>
            </div>

            <div id="casinoTab" class="tab-content">
                <h2>Casino Games</h2>
                <div class="casino-games">
                    <!-- Roulette -->
                    <div class="game-card">
                        <div class="game-title">üé∞ Roulette</div>
                        <input type="number" class="bet-input" id="rouletteBet" placeholder="Bet amount">
                        <select id="rouletteChoice" style="margin: 10px auto; display: block; width: 150px;">
                            <option value="red">Red</option>
                            <option value="black">Black</option>
                        </select>
                        <div class="roulette-wheel">
                            <div class="roulette-result" id="rouletteResult">?</div>
                        </div>
                        <button onclick="playRoulette()">Spin</button>
                        <div id="rouletteMsg" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>

                    <!-- Blackjack -->
                    <div class="game-card">
                        <div class="game-title">üÉè Blackjack</div>
                        <input type="number" class="bet-input" id="blackjackBet" placeholder="Bet amount">
                        <div style="margin: 20px 0;">
                            <div style="margin-bottom: 10px;">Dealer: <span id="dealerScore">0</span></div>
                            <div class="blackjack-cards" id="dealerCards"></div>
                        </div>
                        <div style="margin: 20px 0;">
                            <div style="margin-bottom: 10px;">You: <span id="playerScore">0</span></div>
                            <div class="blackjack-cards" id="playerCards"></div>
                        </div>
                        <div class="game-buttons">
                            <button onclick="startBlackjack()" id="bjStart">Start Game</button>
                            <button onclick="blackjackHit()" id="bjHit" style="display:none;">Hit</button>
                            <button onclick="blackjackStand()" id="bjStand" style="display:none;">Stand</button>
                        </div>
                        <div id="blackjackMsg" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>

                    <!-- Coin Flip -->
                    <div class="game-card">
                        <div class="game-title">ü™ô Coin Flip</div>
                        <input type="number" class="bet-input" id="coinBet" placeholder="Bet amount">
                        <select id="coinChoice" style="margin: 10px auto; display: block; width: 150px;">
                            <option value="heads">Heads</option>
                            <option value="tails">Tails</option>
                        </select>
                        <div class="coin" id="coinDisplay">?</div>
                        <button onclick="flipCoin()">Flip Coin</button>
                        <div id="coinMsg" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBo2zhESYzv1OChHSAfSb2GLiP6XtI6q1s",
        authDomain: "mailcash-3da79.firebaseapp.com",
        projectId: "mailcash-3da79",
        storageBucket: "mailcash-3da79.firebasestorage.app",
        messagingSenderId: "9602664972",
        appId: "1:9602664972:web:2ded4f3a7f583558513c29",
        measurementId: "G-4V6B28HZG4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let selectedMessage = null;
    let userMessages = [];
    let stockInterval = null;
    let blackjackGame = null;

    // Stock data
    const stocks = [
        { symbol: 'TECH', name: 'TechCorp', price: 150, change: 0 },
        { symbol: 'BANK', name: 'BankGroup', price: 85, change: 0 },
        { symbol: 'ENRG', name: 'EnergyPlus', price: 45, change: 0 },
        { symbol: 'FOOD', name: 'FoodChain', price: 120, change: 0 },
        { symbol: 'AUTO', name: 'AutoMakers', price: 95, change: 0 },
        { symbol: 'HLTH', name: 'HealthCare', price: 200, change: 0 }
    ];

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (querySnapshot.empty) return alert("User not found!");
            const recipientDoc = querySnapshot.docs[0];

            await runTransaction(db, async (transaction) => {
                const senderDoc = await transaction.get(doc(db, "users", auth.currentUser.uid));
                
                if (senderDoc.data().balance < amount) throw "Insufficient balance!";

                transaction.update(doc(db, "users", auth.currentUser.uid), {
                    balance: senderDoc.data().balance - amount
                });
                transaction.update(doc(db, "users", recipientDoc.id), {
                    balance: recipientDoc.data().balance + amount
                });
                
                const txnRef = doc(collection(db, "transactions"));
                transaction.set(txnRef, {
                    from: auth.currentUser.email,
                    to: toEmail,
                    amount: amount,
                    message: message || '',
                    participants: [auth.currentUser.email, toEmail],
                    date: new Date()
                });
            });

            alert("Transfer successful!");
            document.getElementById('transferTo').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferMessage').value = '';
            switchTab('transactions');
        } catch (e) { alert(e); }
    };

    // Stock Market
    function startStockUpdates() {
        renderStocks();
        stockInterval = setInterval(() => {
            stocks.forEach(stock => {
                const changePercent = (Math.random() - 0.5) * 10;
                const priceChange = stock.price * (changePercent / 100);
                stock.price = Math.max(10, stock.price + priceChange);
                stock.change = changePercent;
            });
            renderStocks();
        }, 3000);
    }

    function renderStocks() {
        const grid = document.getElementById('stocksGrid');
        grid.innerHTML = stocks.map(stock => `
            <div class="stock-card">
                <div class="stock-name">${stock.name}</div>
                <div style="color: #7f8c8d; font-size: 14px; margin-bottom: 10px;">${stock.symbol}</div>
                <div class="stock-price">${stock.price.toFixed(2)}</div>
                <div class="stock-change ${stock.change >= 0 ? 'positive' : 'negative'}">
                    ${stock.change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(stock.change).toFixed(2)}%
                </div>
                <div class="stock-actions">
                    <input type="number" id="qty-${stock.symbol}" placeholder="Qty" min="1" value="1">
                    <button onclick="buyStock('${stock.symbol}')">Buy</button>
                    <button onclick="sellStock('${stock.symbol}')" style="background: #e74c3c;">Sell</button>
                </div>
            </div>
        `).join('');
    }

    async function updatePortfolioDisplay(portfolio) {
        const container = document.getElementById('portfolioList');
        const entries = Object.entries(portfolio);
        
        if (entries.length === 0) {
            container.innerHTML = '<div style="color: #7f8c8d;">No stocks owned yet</div>';
            return;
        }

        let totalValue = 0;
        container.innerHTML = entries.map(([symbol, qty]) => {
            const stock = stocks.find(s => s.symbol === symbol);
            const value = stock.price * qty;
            totalValue += value;
            return `
                <div class="portfolio-item">
                    <div>
                        <span style="font-weight: 600;">${symbol}</span>
                        <span style="color: #7f8c8d; margin-left: 10px;">${qty} shares</span>
                    </div>
                    <div style="color: #3498db; font-weight: 600;">${value.toFixed(2)}</div>
                </div>
            `;
        }).join('') + `
            <div class="portfolio-item" style="border: none; padding-top: 15px;">
                <div style="font-weight: 600; font-size: 18px;">Total Value</div>
                <div style="color: #27ae60; font-weight: 600; font-size: 18px;">${totalValue.toFixed(2)}</div>
            </div>
        `;
    }

    window.buyStock = async (symbol) => {
        const qty = parseInt(document.getElementById(`qty-${symbol}`).value);
        if (isNaN(qty) || qty <= 0) return alert("Enter valid quantity");

        const stock = stocks.find(s => s.symbol === symbol);
        const cost = stock.price * qty;

        try {
            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(doc(db, "users", auth.currentUser.uid));
                const userData = userDoc.data();

                if (userData.balance < cost) throw "Insufficient balance!";

                const portfolio = userData.portfolio || {};
                portfolio[symbol] = (portfolio[symbol] || 0) + qty;

                transaction.update(doc(db, "users", auth.currentUser.uid), {
                    balance: userData.balance - cost,
                    portfolio: portfolio
                });
            });

            alert(`Bought ${qty} shares of ${symbol} for ${cost.toFixed(2)}`);
        } catch (e) { alert(e); }
    };

    window.sellStock = async (symbol) => {
        const qty = parseInt(document.getElementById(`qty-${symbol}`).value);
        if (isNaN(qty) || qty <= 0) return alert("Enter valid quantity");

        const stock = stocks.find(s => s.symbol === symbol);
        const revenue = stock.price * qty;

        try {
            await runTransaction(db, async (transaction) => {
                const userDoc = await transaction.get(doc(db, "users", auth.currentUser.uid));
                const userData = userDoc.data();
                const portfolio = userData.portfolio || {};

                if (!portfolio[symbol] || portfolio[symbol] < qty) throw "Not enough shares!";

                portfolio[symbol] -= qty;
                if (portfolio[symbol] === 0) delete portfolio[symbol];

                transaction.update(doc(db, "users", auth.currentUser.uid), {
                    balance: userData.balance + revenue,
                    portfolio: portfolio
                });
            });

            alert(`Sold ${qty} shares of ${symbol} for ${revenue.toFixed(2)}`);
        } catch (e) { alert(e); }
    };

    // Casino Games
    window.playRoulette = async () => {
        const bet = parseFloat(document.getElementById('rouletteBet').value);
        const choice = document.getElementById('rouletteChoice').value;

        if (isNaN(bet) || bet <= 0) return alert("Enter valid bet");

        try {
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            if (userDoc.data().balance < bet) return alert("Insufficient balance!");

            const result = Math.random() < 0.5 ? 'red' : 'black';
            document.getElementById('rouletteResult').textContent = result === 'red' ? 'R' : 'B';
            document.getElementById('rouletteResult').style.background = result;
            document.getElementById('rouletteResult').style.color = 'white';

            const won = result === choice;
            const newBalance = userDoc.data().balance + (won ? bet : -bet);

            await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: newBalance });

            document.getElementById('rouletteMsg').textContent = won ? `You won ${bet.toFixed(2)}!` : `You lost ${bet.toFixed(2)}`;
            document.getElementById('rouletteMsg').style.color = won ? '#27ae60' : '#e74c3c';
        } catch (e) { alert(e.message); }
    };

    window.startBlackjack = async () => {
        const bet = parseFloat(document.getElementById('blackjackBet').value);
        if (isNaN(bet) || bet <= 0) return alert("Enter valid bet");

        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
        if (userDoc.data().balance < bet) return alert("Insufficient balance!");

        blackjackGame = {
            bet: bet,
            playerCards: [getRandomCard(), getRandomCard()],
            dealerCards: [getRandomCard()],
            playerScore: 0,
            dealerScore: 0
        };

        updateBlackjackDisplay();
        document.getElementById('bjStart').style.display = 'none';
        document.getElementById('bjHit').style.display = 'inline-block';
        document.getElementById('bjStand').style.display = 'inline-block';
        document.getElementById('blackjackMsg').textContent = '';
    };

    window.blackjackHit = () => {
        blackjackGame.playerCards.push(getRandomCard());
        updateBlackjackDisplay();

        if (blackjackGame.playerScore > 21) {
            endBlackjack(false, "Bust! You lose.");
        }
    };

    window.blackjackStand = () => {
        while (blackjackGame.dealerScore < 17) {
            blackjackGame.dealerCards.push(getRandomCard());
            blackjackGame.dealerScore = calculateScore(blackjackGame.dealerCards);
        }
        
        updateBlackjackDisplay();

        if (blackjackGame.dealerScore > 21) {
            endBlackjack(true, "Dealer busts! You win!");
        } else if (blackjackGame.playerScore > blackjackGame.dealerScore) {
            endBlackjack(true, "You win!");
        } else if (blackjackGame.playerScore < blackjackGame.dealerScore) {
            endBlackjack(false, "Dealer wins!");
        } else {
            endBlackjack(null, "Push! Bet returned.");
        }
    };

    function getRandomCard() {
        const cards = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        return cards[Math.floor(Math.random() * cards.length)];
    }

    function calculateScore(cards) {
        let score = 0;
        let aces = 0;

        cards.forEach(card => {
            if (card === 'A') {
                aces++;
                score += 11;
            } else if (['J', 'Q', 'K'].includes(card)) {
                score += 10;
            } else {
                score += parseInt(card);
            }
        });

        while (score > 21 && aces > 0) {
            score -= 10;
            aces--;
        }

        return score;
    }

    function updateBlackjackDisplay() {
        blackjackGame.playerScore = calculateScore(blackjackGame.playerCards);
        blackjackGame.dealerScore = calculateScore(blackjackGame.dealerCards);

        document.getElementById('playerCards').innerHTML = blackjackGame.playerCards.map(c => 
            `<div class="card">${c}</div>`
        ).join('');
        document.getElementById('dealerCards').innerHTML = blackjackGame.dealerCards.map(c => 
            `<div class="card">${c}</div>`
        ).join('');
        
        document.getElementById('playerScore').textContent = blackjackGame.playerScore;
        document.getElementById('dealerScore').textContent = blackjackGame.dealerScore;
    }

    async function endBlackjack(won, message) {
        document.getElementById('bjHit').style.display = 'none';
        document.getElementById('bjStand').style.display = 'none';
        document.getElementById('bjStart').style.display = 'inline-block';
        document.getElementById('blackjackMsg').textContent = message;
        document.getElementById('blackjackMsg').style.color = won ? '#27ae60' : (won === null ? '#3498db' : '#e74c3c');

        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
        const change = won ? blackjackGame.bet : (won === null ? 0 : -blackjackGame.bet);
        await updateDoc(doc(db, "users", auth.currentUser.uid), {
            balance: userDoc.data().balance + change
        });
    }

    window.flipCoin = async () => {
        const bet = parseFloat(document.getElementById('coinBet').value);
        const choice = document.getElementById('coinChoice').value;

        if (isNaN(bet) || bet <= 0) return alert("Enter valid bet");

        try {
            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
            if (userDoc.data().balance < bet) return alert("Insufficient balance!");

            const result = Math.random() < 0.5 ? 'heads' : 'tails';
            document.getElementById('coinDisplay').textContent = result === 'heads' ? 'H' : 'T';

            const won = result === choice;
            const newBalance = userDoc.data().balance + (won ? bet : -bet);

            await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: newBalance });

            document.getElementById('coinMsg').textContent = won ? `You won ${bet.toFixed(2)}!` : `You lost ${bet.toFixed(2)}`;
            document.getElementById('coinMsg').style.color = won ? '#27ae60' : '#e74c3c';
        } catch (e) { alert(e.message); }
    };

    // Navigation
    window.showRegister = () => {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('registerScreen').classList.remove('hidden');
    };

    window.showLogin = () => {
        document.getElementById('registerScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
    };

    function showApp() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('registerScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.remove('hidden');
    }

    window.switchTab = (tabName) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        const tabButtons = {
            'inbox': 0,
            'compose': 1,
            'transfer': 2,
            'transactions': 3,
            'stocks': 4,
            'casino': 5
        };
        
        const tabs = document.querySelectorAll('.tab');
        if (tabs[tabButtons[tabName]]) {
            tabs[tabButtons[tabName]].classList.add('active');
        }
    };
    </script>
</body>
</html>userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('userNameDisplay').textContent = userData.name;
                document.getElementById('userBalance').textContent = userData.balance.toFixed(2);
                
                // Initialize portfolio if it doesn't exist
                if (!userData.portfolio) {
                    await updateDoc(doc(db, "users", user.uid), { portfolio: {} });
                }
                
                showApp();
                setupRealtimeListeners(user.email, user.uid);
                startStockUpdates();
            }
        } else {
            currentUser = null;
            showLogin();
            if (stockInterval) clearInterval(stockInterval);
        }
    });

    window.register = async () => {
        const name = document.getElementById('regName').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const pass = document.getElementById('regPassword').value;

        if (!name || !email || !pass) return alert("Please fill all fields");

        try {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), {
                name: name,
                email: email,
                balance: 10000.00,
                portfolio: {}
            });
        } catch (e) { alert(e.message); }
    };

    window.login = () => {
        const email = document.getElementById('loginEmail').value.trim();
        const pass = document.getElementById('loginPassword').value;
        signInWithEmailAndPassword(auth, email, pass).catch(e => alert("Login failed: " + e.message));
    };

    window.logout = () => signOut(auth);

    function setupRealtimeListeners(email, uid) {
        onSnapshot(doc(db, "users", uid), (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                document.getElementById('userBalance').textContent = data.balance.toFixed(2);
                updatePortfolioDisplay(data.portfolio || {});
            }
        });

        const msgQuery = query(collection(db, "messages"), where("to", "==", email), orderBy("date", "desc"));
        onSnapshot(msgQuery, (snapshot) => {
            userMessages = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderMessageList();
        });

        const txnQuery = query(collection(db, "transactions"), where("participants", "array-contains", email), orderBy("date", "desc"));
        onSnapshot(txnQuery, (snapshot) => {
            const container = document.getElementById('transactionsList');
            if (snapshot.empty) {
                container.innerHTML = '<div class="empty-state">No transactions</div>';
                return;
            }
            container.innerHTML = snapshot.docs.map(d => {
                const data = d.data();
                const isReceived = data.to === email;
                return `
                    <div class="transaction-item">
                        <div class="transaction-header">
                            <div>
                                <div class="transaction-type">${isReceived ? 'Received from' : 'Sent to'}: ${isReceived ? data.from : data.to}</div>
                                ${data.message ? `<div style="color: #95a5a6; font-size: 14px; margin-top: 5px;">${data.message}</div>` : ''}
                                <div class="transaction-date">${data.date.toDate().toLocaleString()}</div>
                            </div>
                            <div class="transaction-amount ${isReceived ? 'received' : 'sent'}">
                                ${isReceived ? '+' : '-'}$${data.amount.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        });
    }

    function renderMessageList() {
        const container = document.getElementById('messageList');
        if (userMessages.length === 0) {
            container.innerHTML = '<div class="empty-state">No messages</div>';
            return;
        }
        container.innerHTML = userMessages.map(msg => `
            <div class="message-preview ${selectedMessage && selectedMessage.id === msg.id ? 'selected' : ''}" 
                 onclick="selectMessage('${msg.id}')">
                <div class="message-from">${msg.from}</div>
                <div class="message-subject">${msg.subject}</div>
                <div class="message-date">${msg.date.toDate().toLocaleString()}</div>
            </div>
        `).join('');
    }

    window.selectMessage = (msgId) => {
        selectedMessage = userMessages.find(m => m.id === msgId);
        renderMessageList();
        
        const detail = document.getElementById('messageDetail');
        if (selectedMessage) {
            detail.innerHTML = `
                <div class="message-from">From: ${selectedMessage.from}</div>
                <div class="message-subject" style="font-size: 24px; margin: 15px 0;">${selectedMessage.subject}</div>
                <div class="message-date" style="margin-bottom: 20px;">${selectedMessage.date.toDate().toLocaleString()}</div>
                <div class="message-body" style="line-height: 1.6; font-size: 16px;">${selectedMessage.body}</div>
            `;
        }
    };

    window.toggleMoneyInput = () => {
        const checkbox = document.getElementById('includeMoney');
        const input = document.getElementById('emailMoney');
        input.style.display = checkbox.checked ? 'block' : 'none';
    };

    window.sendEmail = async () => {
        const to = document.getElementById('emailTo').value.trim();
        const subject = document.getElementById('emailSubject').value.trim();
        const body = document.getElementById('emailBody').value.trim();
        const includeMoney = document.getElementById('includeMoney').checked;
        const amount = parseFloat(document.getElementById('emailMoney').value);

        if (!to || !subject || !body) return alert("Fill all fields");
        if (includeMoney && (isNaN(amount) || amount <= 0)) return alert("Enter valid amount");

        try {
            if (includeMoney) {
                const q = query(collection(db, "users"), where("email", "==", to));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return alert("User not found!");
                const recipientDoc = querySnapshot.docs[0];

                await runTransaction(db, async (transaction) => {
                    const senderDoc = await transaction.get(doc(db, "users", auth.currentUser.uid));
                    if (senderDoc.data().balance < amount) throw "Insufficient balance!";

                    transaction.update(doc(db, "users", auth.currentUser.uid), {
                        balance: senderDoc.data().balance - amount
                    });
                    transaction.update(doc(db, "users", recipientDoc.id), {
                        balance: recipientDoc.data().balance + amount
                    });

                    const txnRef = doc(collection(db, "transactions"));
                    transaction.set(txnRef, {
                        from: auth.currentUser.email,
                        to: to,
                        amount: amount,
                        message: `Sent with email: ${subject}`,
                        participants: [auth.currentUser.email, to],
                        date: new Date()
                    });
                });
            }

            await addDoc(collection(db, "messages"), {
                from: auth.currentUser.email,
                to: to,
                subject: subject,
                body: body + (includeMoney ? `\n\n[Money Transfer: $${amount.toFixed(2)}]` : ''),
                date: new Date()
            });

            alert("Email sent" + (includeMoney ? " with money!" : "!"));
            document.getElementById('emailTo').value = '';
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailBody').value = '';
            document.getElementById('includeMoney').checked = false;
            document.getElementById('emailMoney').value = '';
            toggleMoneyInput();
            switchTab('inbox');
        } catch (e) { alert(e); }
    };

    window.sendMoney = async () => {
        const toEmail = document.getElementById('transferTo').value.trim();
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const message = document.getElementById('transferMessage').value.trim();

        if (!toEmail || isNaN(amount) || amount <= 0) return alert("Enter valid recipient and amount");
        if (toEmail === auth.currentUser.email) return alert("You cannot send money to yourself");

        try {
            const q = query(collection(db, "users"), where("email", "==", toEmail));
            const querySnapshot = await getDocs(q);
            
            if (
