<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailCash | Ultimate Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0b0f19; color: #f8fafc; padding: 20px; overflow-x: hidden; font-size: 18px; }
        .container { width: 100%; max-width: 1600px; margin: 0 auto; position: relative; transition: transform 0.1s; }
        .card { background: #151b2b; border-radius: 16px; padding: 30px; border: 1px solid #334155; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        
        /* INPUTS & BUTTONS */
        input, textarea, select { width: 100%; padding: 16px; background: #0f172a; border: 1px solid #475569; border-radius: 12px; color: white; margin-bottom: 15px; outline: none; font-size: 16px; font-weight: 500; transition: 0.3s; }
        input:focus { border-color: #6366f1; box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
        button { width: 100%; padding: 16px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: all 0.2s; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4); }
        button:active { transform: scale(0.98); }
        button:disabled { background: #334155; color: #64748b; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 10px; flex-wrap: wrap; }
        .balance-pill { background: #022c22; color: #34d399; padding: 10px 24px; border-radius: 50px; font-weight: 900; border: 2px solid #059669; font-size: 20px; box-shadow: 0 0 20px rgba(16, 185, 129, 0.2); }
        .header-prestige-btn { background: linear-gradient(135deg, #7c3aed, #db2777); border: 2px solid #f472b6; box-shadow: 0 0 25px rgba(219, 39, 119, 0.4); }
        .pfp-circle { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #6366f1; background: #1e293b; cursor: pointer; transition: 0.3s; }
        .pfp-circle:hover { border-color: #f472b6; transform: rotate(10deg); }
        
        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #151b2b; padding: 10px; border-radius: 16px; overflow-x: auto; border: 1px solid #334155; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 10px; color: #94a3b8; font-weight: 800; font-size: 14px; white-space: nowrap; transition: 0.3s; }
        .tab:hover { background: #1e293b; color: white; }
        .tab.active { background: linear-gradient(135deg, #334155, #475569); color: white; border: 1px solid #64748b; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        
        /* GRIDS */
        .orb-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-top: 25px; }
        .orb-item { background: #111827; border: 1px solid #374151; padding: 20px; border-radius: 16px; position: relative; text-align: center; display: flex; flex-direction: column; justify-content: space-between; min-height: 250px; transition: 0.3s; overflow: hidden; }
        .orb-item:hover { border-color: #6366f1; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* --- MARVEL-LEVEL VISUAL ENGINE --- */
        .visual-container { position: relative; width: 100px; height: 100px; margin: 0 auto 20px; display: flex; justify-content: center; align-items: center; perspective: 500px; }
        .orb-visual { width: 70px; height: 70px; border-radius: 50%; position: relative; z-index: 5; background: currentColor; box-shadow: inset -10px -10px 20px rgba(0,0,0,0.8), 0 0 25px currentColor; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Base Stages */
        .stage-1 { border-radius: 50%; }
        .stage-2 { border-radius: 40%; transform: rotate(45deg); }
        .stage-3 { border-radius: 50%; animation: pulseGlow 2s infinite alternate; }
        .stage-4 { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); animation: diamondFloat 3s infinite ease-in-out; }
        .stage-5 { clip-path: polygon(50% 0%, 80% 10%, 100% 35%, 100% 70%, 80% 90%, 50% 100%, 20% 90%, 0% 70%, 0% 35%, 20% 10%); animation: polySpin 10s linear infinite; }

        @keyframes pulseGlow { from { box-shadow: 0 0 20px currentColor; transform: scale(1); } to { box-shadow: 0 0 50px currentColor; transform: scale(1.1); } }
        @keyframes diamondFloat { 0%, 100% { transform: translateY(0) rotate(45deg); } 50% { transform: translateY(-10px) rotate(45deg); } }
        @keyframes polySpin { to { transform: rotate(360deg); } }

        /* --- SPECIALIZATIONS (VFX) --- */
        
        /* CORE (DIVINITY) - White/Blue Holy Light */
        .spec-core .orb-visual { background: radial-gradient(circle at 30% 30%, #ffffff, #60a5fa, #1e3a8a); box-shadow: 0 0 60px #60a5fa, 0 0 100px #ffffff; animation: divineFloat 4s infinite ease-in-out; }
        .spec-core::after { content: ''; position: absolute; width: 140%; height: 140%; border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; animation: ringSpin 5s linear infinite; }
        .spec-core::before { content: ''; position: absolute; width: 180%; height: 2px; background: linear-gradient(90deg, transparent, white, transparent); animation: godRays 3s infinite; }
        
        /* MAGIC (CHAOS) - Glitchy Red/Black */
        .spec-magic .orb-visual { background: radial-gradient(circle, #ef4444, #000); box-shadow: 0 0 40px #ef4444, inset 0 0 30px #000; animation: chaosShake 0.2s infinite; filter: contrast(1.5); }
        .spec-magic::after { content: ''; position: absolute; inset: -20px; border: 4px solid #ef4444; clip-path: polygon(0 0, 100% 0, 100% 10%, 0 10%); animation: glitchLines 1s infinite linear; opacity: 0.7; }
        
        /* STRENGTH (OVERLOAD) - Orange Electric */
        .spec-strength .orb-visual { background: #f97316; box-shadow: 0 0 50px #f97316, 0 0 10px #fff; animation: powerSurge 0.1s infinite alternate; }
        .spec-strength .fx-particle { position: absolute; width: 100%; height: 100%; border: 2px solid #fdba74; border-radius: 50%; opacity: 0; animation: shockwave 1.5s infinite; }
        
        /* WISDOM (CYBER) - Green Matrix */
        .spec-wisdom .orb-visual { background: #000; border: 2px solid #22c55e; box-shadow: 0 0 30px #22c55e, inset 0 0 10px #22c55e; }
        .spec-wisdom::after { content: ''; position: absolute; width: 120%; height: 120%; border: 1px dashed #4ade80; border-radius: 50%; animation: techSpin 10s linear infinite; }
        .spec-wisdom::before { content: ''; position: absolute; width: 140%; height: 140%; border-top: 2px solid #22c55e; border-bottom: 2px solid #22c55e; border-radius: 50%; animation: techSpin 5s linear infinite reverse; }

        @keyframes divineFloat { 0%, 100% { transform: translateY(0); filter: brightness(1.2); } 50% { transform: translateY(-15px); filter: brightness(1.5); } }
        @keyframes ringSpin { from { transform: rotate(0deg) scale(0.8); opacity: 0; } to { transform: rotate(180deg) scale(1.2); opacity: 0; } }
        @keyframes godRays { 0% { transform: rotate(0deg); opacity: 0; } 50% { opacity: 1; } 100% { transform: rotate(180deg); opacity: 0; } }
        
        @keyframes chaosShake { 0% { transform: translate(1px, 1px) skewX(0deg); } 20% { transform: translate(-2px, -1px) skewX(5deg); } 40% { transform: translate(2px, 1px) skewX(-5deg); } 100% { transform: translate(0, 0); } }
        @keyframes glitchLines { 0% { top: -10%; } 100% { top: 110%; } }

        @keyframes powerSurge { from { transform: scale(1); filter: hue-rotate(0deg); } to { transform: scale(1.05); filter: hue-rotate(15deg); } }
        @keyframes shockwave { 0% { transform: scale(1); opacity: 1; border-width: 5px; } 100% { transform: scale(2); opacity: 0; border-width: 0px; } }

        @keyframes techSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* SCREEN SHAKE ANIMATION */
        .shake-screen { animation: screenShake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes screenShake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        /* LAYOUT & RESEARCH */
        .research-container { display: grid; grid-template-columns: 350px 1fr; gap: 30px; align-items: start; height: calc(100vh - 200px); min-height: 600px; }
        .research-sidebar { background: #151b2b; border-right: 2px solid #334155; padding: 20px; overflow-y: auto; height: 100%; border-radius: 16px; }
        .research-chamber { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); border-radius: 16px; border: 2px solid #334155; position: relative; display: flex; flex-direction: column; height: 100%; padding: 30px; overflow: hidden; }
        .chamber-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: 100%; }
        
        .upgrade-col { display: flex; flex-direction: column; gap: 15px; justify-content: center; }
        .visual-col { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0b0f19; border-radius: 20px; border: 2px solid #475569; position: relative; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); }
        .visual-col::before { content: ''; position: absolute; inset: 0; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); opacity: 0.1; }

        .stat-card { background: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .stat-card:hover { border-color: #6366f1; background: #262f45; }

        .res-item { padding: 15px; background: #1e293b; margin-bottom: 10px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .res-item:hover { background: #334155; transform: translateX(5px); }
        .res-item.active { border-color: #6366f1; background: #312e81; box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }

        /* MISC UI */
        .blur-lock { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: 16px; font-weight: 900; font-size: 24px; color: #475569; }
        .progress-bg { width: 100px; height: 8px; background: #0f172a; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); }
        .search-bar { width: 300px; margin: 0; height: 50px; border-radius: 25px; padding-left: 20px; background: #1e293b; border: 1px solid #475569; }

        .loot-popup-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; backdrop-filter: blur(10px); }
        .loot-popup-card { background: #1e293b; padding:50px; border-radius:30px; text-align:center; width:500px; border:2px solid #6366f1; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 100px rgba(99, 102, 241, 0.4); }
        @keyframes popIn { 0% { transform: scale(0.5); opacity:0; } 100% { transform: scale(1); opacity:1; } }

        .notif-banner { position: fixed; top: 25px; left: -400px; background: linear-gradient(90deg, #6366f1, #8b5cf6); padding: 15px 30px; border-radius: 50px; z-index: 100000; font-weight: 800; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4); transition: left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: white; display:flex; align-items:center; gap:10px;}
        .notif-banner.active { left: 25px; }
        .orb-stats-top { position: absolute; top: 15px; left: 15px; z-index: 10; font-size: 12px; font-weight: 900; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 6px; }
    </style>
</head>
<body>

<div id="notifBanner" class="notif-banner">
    <div style="width:10px; height:10px; background:#4ade80; border-radius:50%; box-shadow:0 0 10px #4ade80;"></div>
    <span id="notifText">Notification</span>
</div>

<div id="lootPopup" class="loot-popup-overlay hidden">
    <div class="loot-popup-card">
        <h1 style="color:#facc15; margin-bottom:30px; text-transform:uppercase; letter-spacing:2px; text-shadow:0 0 20px rgba(250,204,21,0.5);">Artifact Discovered</h1>
        <div id="lootRevealVisual" style="margin-bottom: 30px; transform:scale(1.5);"></div>
        <h2 id="lootRevealName" style="font-size:32px; margin-bottom:10px;">Unknown Orb</h2>
        <p id="lootRevealStats" style="color:#94a3b8; font-size:18px; margin-bottom:30px; font-family:monospace;">Analysing...</p>
        <button onclick="document.getElementById('lootPopup').classList.add('hidden')" style="width:200px; margin:0 auto; background:#10b981;">CLAIM</button>
    </div>
</div>

<div id="mainContainer" class="container">
    <div id="authScreen" class="card" style="max-width: 500px; margin: 100px auto; text-align:center; padding: 50px;">
        <h1 style="font-size:48px; margin-bottom:30px; background:linear-gradient(to right, #6366f1, #a855f7); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">MAILCASH</h1>
        <input type="text" id="loginUser" placeholder="Username">
        <div id="regArea" class="hidden"><input type="email" id="regEmail" placeholder="Email Address"></div>
        <input type="password" id="authPass" placeholder="Password">
        <button id="authBtn" style="margin-top:20px;">INITIALIZE LINK</button>
        <p style="margin-top:20px; font-size:14px; color:#64748b; cursor:pointer;" onclick="toggleAuth()">Toggle Login / Register</p>
    </div>

    <div id="appScreen" class="hidden">
        <div class="header">
            <div style="display:flex; align-items:center; gap:20px;">
                <img id="userPfp" class="pfp-circle" src="" onclick="toggleSettings()">
                <button class="header-prestige-btn" onclick="showTab('prestige')">
                    ‚ú® ASCENSION <span id="headerPoints" style="background:rgba(0,0,0,0.2); padding:2px 8px; border-radius:4px; margin-left:5px;">0</span>
                </button>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                <input type="text" id="globalSearch" class="search-bar" placeholder="üîç Search Database..." onkeyup="handleSearch()">
                <div class="balance-pill">$<span id="userBal">0</span></div>
                <button onclick="logout()" style="width:50px; background:#ef4444;">X</button>
            </div>
        </div>

        <div class="tabs">
            <div id="tEar" class="tab active" onclick="showTab('earn')">PRODUCTION</div>
            <div id="tRes" class="tab" onclick="showTab('research')">RESEARCH LAB</div>
            <div id="tCol" class="tab" onclick="showTab('collection')">ARMORY</div>
            <div id="tMkt" class="tab" onclick="showTab('marketplace')">MARKET</div>
            <div id="tIn" class="tab" onclick="showTab('inbox')">COMMS</div>
            <div id="tMsg" class="tab" onclick="showTab('message')">TRANSMIT</div>
        </div>

        <div id="earnView" class="tab-view">
            <div style="text-align:center; margin-bottom: 40px;">
                <button class="clicker-btn" id="mainClicker">‚ö°</button>
                <div style="background:#1e293b; display:inline-flex; align-items:center; gap:20px; padding:10px 20px; border-radius:12px; border:1px solid #334155;">
                    <span style="color:#94a3b8; font-weight:800;">CLICK POWER: <span id="clickPowerVal" style="color:#fff;">1</span></span>
                    <button id="upgradeClickBtn" onclick="upgradeClicker()" style="width:auto; padding:8px 15px; font-size:12px;">UPGRADE</button>
                </div>
            </div>
            <div class="orb-grid" id="orbGrid"></div>
        </div>

        <div id="researchView" class="tab-view hidden">
            <div class="research-container">
                <div class="research-sidebar">
                    <h3 style="color:#6366f1; margin-bottom:20px; text-transform:uppercase; letter-spacing:1px;">Available Assets</h3>
                    <div id="researchOrbList"></div>
                </div>

                <div class="research-chamber">
                    <div id="researchPlaceholder" style="position:absolute; inset:0; display:flex; justify-content:center; align-items:center; background:#0f172a; z-index:10; color:#475569; font-weight:bold;">
                        SELECT ASSET TO BEGIN MODIFICATION
                    </div>
                    
                    <div class="chamber-grid">
                        <div class="upgrade-col">
                            <h2 id="researchOrbName" style="font-size:32px; margin-bottom:10px; color:#fff;">Target Name</h2>
                            <div id="statContainer"></div>
                            <p style="font-size:12px; color:#64748b; margin-top:20px; line-height:1.5;">
                                INFO: Max Level 2 for standard stats.<br>
                                Reaching Level 5 in ONE stat unlocks a specialized Visual Form.
                            </p>
                        </div>
                        
                        <div class="visual-col">
                            <div style="position:absolute; top:20px; color:#94a3b8; font-size:12px; letter-spacing:2px;">REAL-TIME SIMULATION</div>
                            <div id="researchPreview" style="transform: scale(2);"></div>
                            <div id="visualStatus" style="position:absolute; bottom:20px; color:#10b981; font-weight:bold; font-size:14px;">STABLE</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="collectionView" class="tab-view hidden">
            <div class="orb-grid" id="collectionGrid"></div>
        </div>

        <div id="marketplaceView" class="tab-view hidden">
            <div class="chest-grid">
                <div class="chest-card">
                    <div style="font-size:50px; margin-bottom:10px;">üì¶</div>
                    <h3>SUPPLY CRATE</h3>
                    <div style="color:#d97706; font-weight:900; margin:5px 0;">$1,000</div>
                    <button onclick="buyChest('bronze', 1000)">PURCHASE</button>
                </div>
                <div class="chest-card">
                    <div style="font-size:50px; margin-bottom:10px;">üîí</div>
                    <h3>SECURE VAULT</h3>
                    <div style="color:#cbd5e1; font-weight:900; margin:5px 0;">$25,000</div>
                    <button onclick="buyChest('silver', 25000)">PURCHASE</button>
                </div>
                <div class="chest-card">
                    <div style="font-size:50px; margin-bottom:10px;">‚öóÔ∏è</div>
                    <h3>ALIEN POD</h3>
                    <div style="color:#facc15; font-weight:900; margin:5px 0;">$500,000</div>
                    <button onclick="buyChest('gold', 500000)">PURCHASE</button>
                </div>
                <div class="chest-card">
                    <div style="font-size:50px; margin-bottom:10px;">‚öõÔ∏è</div>
                    <h3>OMEGA ARTIFACT</h3>
                    <div style="color:#a855f7; font-weight:900; margin:5px 0;">$2,500,000</div>
                    <button onclick="buyChest('champion', 2500000)">PURCHASE</button>
                </div>
            </div>
            <h3 style="margin-top:40px; border-bottom:1px solid #334155; padding-bottom:10px; color:#94a3b8;">DISCOVERED ARTIFACTS</h3>
            <div id="lootMarketplaceContainer"></div>
        </div>

        <div id="prestigeView" class="tab-view hidden">
            <div style="text-align:center; padding:50px; background:radial-gradient(circle, #1e293b, #0f172a); border-radius:20px; border:1px solid #4f46e5; margin-bottom:40px;">
                <h1 style="font-size:48px; margin-bottom:10px;">ASCENSION</h1>
                <p style="color:#94a3b8; margin-bottom:30px;">Reset reality to gain permanent power.</p>
                <div style="font-size:24px; font-weight:bold; margin-bottom:20px;">
                    CURRENT POINTS: <span id="prestigePointsDisplay" style="color:#facc15">0</span>
                    <div style="font-size:14px; color:#64748b; margin-top:5px;">Pending on Reset: <span id="pendingPrestigePoints" style="color:#fff;">0</span></div>
                </div>
                <button id="doPrestigeBtn" onclick="doPrestige()" style="background:#ef4444; width:300px;">INITIATE RESET PROTOCOL</button>
            </div>
            <div id="prestigeUpgradesContainer"></div>
        </div>

        <div id="inboxView" class="tab-view hidden"><div id="mailBox" style="padding:20px; text-align:center; color:#64748b;">Scanning Frequencies...</div></div>
        <div id="messageView" class="tab-view hidden card" style="max-width:600px; margin:0 auto;">
            <h3 style="margin-bottom:20px;">TRANSMIT DATA</h3>
            <input type="text" id="msgTo" placeholder="Recipient ID">
            <textarea id="msgBody" rows="5" placeholder="Message content..."></textarea>
            <input type="number" id="payAmt" placeholder="Attach Credits (Optional)">
            <button onclick="handleCombinedSend()">SEND TRANSMISSION</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, query, collection, where, getDocs, increment, orderBy, addDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyBo2zhESYzv1OChHSAfSb2GLiP6XtI6q1s", authDomain: "mailcash-3da79.firebaseapp.com", projectId: "mailcash-3da79", storageBucket: "mailcash-3da79.firebasestorage.app", messagingSenderId: "9602664972", appId: "1:9602664972:web:2ded4f3a7f583558513c29" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userData = null;
    let myUid = null;
    let localBalanceAccumulator = 0;
    let searchFilter = "";
    let selectedResearchOrb = null;
    let isReg = false;

    // COOLER NAMES & DATA
    const ORB_DATA = [
        { id: 'orb1', name: 'Azure Pulsar', baseCost: 350, baseInc: 15, time: 5000, color: '#3b82f6' },
        { id: 'orb2', name: 'Crimson Dwarf', baseCost: 3000, baseInc: 200, time: 7000, color: '#ef4444' },
        { id: 'orb3', name: 'Emerald Singularity', baseCost: 15000, baseInc: 850, time: 6000, color: '#10b981' },
        { id: 'orb4', name: 'Gilded Nova', baseCost: 50000, baseInc: 3500, time: 4000, color: '#f59e0b' },
        { id: 'orb5', name: 'Void Prism', baseCost: 150000, baseInc: 12000, time: 5000, color: '#8b5cf6' },
        { id: 'orb6', name: 'Neutron Star', baseCost: 400000, baseInc: 40000, time: 5000, color: '#06b6d4' },
        { id: 'orb7', name: 'Plasma Rose', baseCost: 1000000, baseInc: 120000, time: 8000, color: '#ec4899' },
        { id: 'orb8', name: 'Celestial Core', baseCost: 4000000, baseInc: 500000, time: 10000, color: '#f8fafc' },
        { id: 'orb9', name: 'Abyssal Event', baseCost: 20000000, baseInc: 3000000, time: 12000, color: '#475569' },
        { id: 'orb10', name: 'Omni-Sun', baseCost: 80000000, baseInc: 15000000, time: 15000, color: '#fbbf24' }
    ];

    const RESEARCH_TYPES = ['core', 'magic', 'power', 'wisdom', 'strength'];
    const RESEARCH_COST = 50000;

    // --- VISUAL GENERATOR ---
    const generateOrbHTML = (orb, count, isPreview = false) => {
        const r = userData.research?.[orb.id] || {};
        let stage = isPreview ? 'stage-3' : getStageClass(count);
        let specClass = "";
        let extra = "";

        if(r.core > 2) specClass = "spec-core";
        else if(r.magic > 2) specClass = "spec-magic";
        else if(r.strength > 2) { specClass = "spec-strength"; extra = `<div class="fx-particle" style="animation-delay:0s"></div><div class="fx-particle" style="animation-delay:0.5s"></div>`; }
        else if(r.wisdom > 2) specClass = "spec-wisdom";

        return `<div class="visual-container ${specClass}">
                    <div class="orb-visual ${stage}" style="background:currentColor; color:${orb.color};"></div>
                    ${extra}
                </div>`;
    };

    // --- LOGIC ---
    onAuthStateChanged(auth, u => {
        if(u) {
            myUid = u.uid;
            onSnapshot(doc(db, "users", u.uid), d => {
                if(d.exists()) {
                    userData = d.data();
                    if(!userData.research) userData.research = {};
                    updateUI();
                    renderOrbs();
                    renderCollection();
                    renderResearchList();
                    if(selectedResearchOrb) {
                        const orb = ORB_DATA.find(o => o.id === selectedResearchOrb);
                        if(orb) updateResearchPanel(orb);
                    }
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('appScreen').classList.remove('hidden');
                }
            });
        }
    });

    // --- RESEARCH TAB ---
    function renderResearchList() {
        const list = document.getElementById('researchOrbList');
        list.innerHTML = '';
        ORB_DATA.forEach(orb => {
            if((userData.orbs?.[orb.id] || 0) > 0) {
                const div = document.createElement('div');
                div.className = `res-item ${selectedResearchOrb === orb.id ? 'active' : ''}`;
                div.innerHTML = `<b>${orb.name}</b> <span style="font-size:12px; color:#94a3b8;">LVL ${calculateOrbLevel(orb, userData.orbs[orb.id])}</span>`;
                div.onclick = () => {
                    selectedResearchOrb = orb.id;
                    document.getElementById('researchPlaceholder').classList.add('hidden');
                    renderResearchList(); // refresh active state
                    updateResearchPanel(orb);
                };
                list.appendChild(div);
            }
        });
    }

    function updateResearchPanel(orb) {
        document.getElementById('researchOrbName').innerText = orb.name;
        document.getElementById('researchPreview').innerHTML = generateOrbHTML(orb, 1, true);
        
        const r = userData.research?.[orb.id] || {};
        const container = document.getElementById('statContainer');
        container.innerHTML = '';

        // Determine active specialization
        let activeSpec = null;
        RESEARCH_TYPES.forEach(t => { if((r[t]||0) > 2) activeSpec = t; });

        // Update Visual Status Text
        const vStatus = document.getElementById('visualStatus');
        if(activeSpec) {
            vStatus.innerText = `VISUAL STABLE: ${activeSpec.toUpperCase()} PROTOCOL`;
            vStatus.style.color = "#10b981";
        } else {
            vStatus.innerText = "VISUAL STABLE: STANDARD";
            vStatus.style.color = "#94a3b8";
        }

        RESEARCH_TYPES.forEach(type => {
            const lvl = r[type] || 0;
            const row = document.createElement('div');
            row.className = 'stat-card';
            
            let canUpgrade = false;
            let btnTxt = "MAX";
            
            if(lvl < 5) {
                // Logic: Up to lvl 2 is free for all. Lvl 3+ requires being the ONLY spec.
                if(lvl < 2 || (activeSpec === type || !activeSpec)) {
                    canUpgrade = true;
                    btnTxt = `UPG ($${(RESEARCH_COST/1000)}k)`;
                } else {
                    btnTxt = "LOCKED";
                }
            }

            row.innerHTML = `
                <div>
                    <div style="font-weight:bold; text-transform:uppercase; font-size:14px; color:${activeSpec === type ? '#facc15' : '#cbd5e1'}">${type} <span style="background:#0f172a; padding:2px 6px; border-radius:4px; font-size:10px;">LVL ${lvl}</span></div>
                    <div class="progress-bg" style="width:150px"><div class="progress-fill" style="width:${(lvl/5)*100}%"></div></div>
                </div>
                <button 
                    onclick="buyResearch('${orb.id}', '${type}')" 
                    ${canUpgrade && userData.balance >= RESEARCH_COST ? '' : 'disabled'}
                    style="width:auto; padding:8px 12px; font-size:12px;">
                    ${btnTxt}
                </button>
            `;
            container.appendChild(row);
        });
    }

    window.buyResearch = async (orbId, type) => {
        if(userData.balance < RESEARCH_COST) return;
        const key = `research.${orbId}.${type}`;
        
        // FX: Shake Screen
        document.getElementById('mainContainer').classList.add('shake-screen');
        setTimeout(() => document.getElementById('mainContainer').classList.remove('shake-screen'), 400);

        await updateDoc(doc(db, "users", myUid), {
            balance: increment(-RESEARCH_COST),
            [key]: increment(1)
        });
    };

    // --- CORE GAMEPLAY ---
    function renderOrbs() {
        const grid = document.getElementById('orbGrid');
        grid.innerHTML = '';
        ORB_DATA.forEach(orb => {
            if(searchFilter && !orb.name.toLowerCase().includes(searchFilter)) return;
            const owned = userData.orbs?.[orb.id] || 0;
            const cost = Math.floor(orb.baseCost * Math.pow(1.3, owned));
            const income = calcIncome(orb, owned);
            const isUnlocked = owned > 0 || orb.id === 'orb1' || (userData.orbs?.[ORB_DATA[ORB_DATA.indexOf(orb)-1].id] > 0);
            
            const div = document.createElement('div'); div.className = 'orb-item';
            div.innerHTML = `
                ${isUnlocked ? `<div class="orb-stats-top">x${owned} | LVL ${calculateOrbLevel(orb, owned)}</div>` : ''}
                ${generateOrbHTML(orb, owned)}
                <h3 style="margin-top:10px;">${orb.name}</h3>
                ${isUnlocked ? `<div style="color:#34d399; font-weight:bold; margin-bottom:10px;">+$${income.toLocaleString()}/s</div>` : ''}
                <button onclick="buyOrb('${orb.id}', ${cost})" ${isUnlocked && userData.balance >= cost ? '' : 'disabled'}>
                    ${isUnlocked ? `BUY $${cost.toLocaleString()}` : 'LOCKED'}
                </button>
                ${!isUnlocked ? `<div class="blur-lock">LOCKED</div>` : ''}
            `;
            grid.appendChild(div);
        });
    }

    window.buyOrb = async (id, cost) => {
        if(userData.balance >= cost) await updateDoc(doc(db, "users", myUid), { balance: increment(-cost), [`orbs.${id}`]: increment(1) });
    };

    window.buyChest = async (tier, cost) => {
        if(userData.balance < cost) return alert("Insufficient Funds");
        const tiers = { bronze: [1, 40], silver: [45, 150], gold: [200, 600], champion: [1000, 5000] };
        const range = tiers[tier];
        const income = Math.floor(Math.random() * (range[1] - range[0])) + range[0];
        const name = `${['Ancient','Lost','Cosmic','Dark'][Math.floor(Math.random()*4)]} ${['Relic','Shard','Core','Gem'][Math.floor(Math.random()*4)]}`;
        const color = '#' + Math.floor(Math.random()*16777215).toString(16);
        
        const newOrb = { id: Date.now().toString(), name, color, income, tier, time: Math.floor(Math.random()*5000)+3000 };
        
        // Popup
        const popup = document.getElementById('lootPopup');
        document.getElementById('lootRevealName').innerText = name;
        document.getElementById('lootRevealName').style.color = color;
        document.getElementById('lootRevealStats').innerText = `TIER: ${tier.toUpperCase()} | +$${income}/cycle`;
        document.getElementById('lootRevealVisual').innerHTML = `<div class="orb-visual stage-3" style="width:100px; height:100px; background:${color}; box-shadow:0 0 50px ${color}; border-radius:50%;"></div>`;
        popup.classList.remove('hidden');

        await updateDoc(doc(db, "users", myUid), { balance: increment(-cost), uniqueOrbs: arrayUnion(newOrb) });
    };

    function renderCollection() {
        const grid = document.getElementById('collectionGrid');
        grid.innerHTML = '';
        ORB_DATA.forEach(orb => {
            if((userData.orbs?.[orb.id] || 0) > 0) {
                const div = document.createElement('div'); div.className = 'orb-item';
                div.innerHTML = `${generateOrbHTML(orb, userData.orbs[orb.id])}<b>${orb.name}</b><div>Owned: ${userData.orbs[orb.id]}</div>`;
                grid.appendChild(div);
            }
        });
    }
    
    // --- HELPERS ---
    const getStageClass = (n) => n > 40 ? 'stage-5' : n > 30 ? 'stage-4' : n > 20 ? 'stage-3' : n > 10 ? 'stage-2' : 'stage-1';
    const calculateOrbLevel = (o, n) => Math.floor(n/10) + 1;
    const calcIncome = (o, n) => Math.floor(o.baseInc * n * (1 + (userData.prestigePoints || 0) * 0.01)); // Simple prestige boost integration

    // --- GAME LOOP ---
    setInterval(() => {
        if(userData) {
            ORB_DATA.forEach(o => {
                if(userData.orbs?.[o.id]) localBalanceAccumulator += (calcIncome(o, userData.orbs[o.id]) / (o.time/100)); // Approx per tick
            });
            if(userData.uniqueOrbs) userData.uniqueOrbs.forEach(u => localBalanceAccumulator += (u.income / (u.time/100)));
            
            document.getElementById('userBal').innerText = Math.floor(userData.balance + localBalanceAccumulator).toLocaleString();
        }
    }, 100);

    setInterval(async () => {
        if(localBalanceAccumulator > 1 && myUid) {
            const add = Math.floor(localBalanceAccumulator);
            localBalanceAccumulator -= add;
            await updateDoc(doc(db, "users", myUid), { balance: increment(add) });
        }
    }, 5000);

    // --- AUTH & TABS ---
    window.showTab = (id) => {
        document.querySelectorAll('.tab-view').forEach(e => e.classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.getElementById(`${id}View`).classList.remove('hidden');
        document.getElementById(`t${id.charAt(0).toUpperCase() + id.slice(1,3)}`).classList.add('active');
        if(id === 'research') renderResearchList();
    };
    
    window.toggleAuth = () => { isReg = !isReg; document.getElementById('regArea').classList.toggle('hidden'); document.getElementById('authBtn').innerText = isReg ? "REGISTER SYSTEM" : "INITIALIZE LINK"; };
    document.getElementById('authBtn').onclick = async () => {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('authPass').value;
        const e = document.getElementById('regEmail').value;
        try {
            if(isReg) {
                const r = await createUserWithEmailAndPassword(auth, e, p);
                await setDoc(doc(db, "users", r.user.uid), { username: u, email: e, balance: 1000, orbs: {}, uniqueOrbs: [], research: {}, prestigePoints: 0 });
            } else {
                const q = query(collection(db, "users"), where("username", "==", u));
                const snap = await getDocs(q);
                if(snap.empty) throw new Error("User not found");
                await signInWithEmailAndPassword(auth, snap.docs[0].data().email, p);
            }
        } catch(err) { alert(err.message); }
    };
    
    document.getElementById('mainClicker').onclick = () => { localBalanceAccumulator += 1; };
    window.logout = () => signOut(auth).then(() => location.reload());
    window.handleSearch = () => { searchFilter = document.getElementById('globalSearch').value.toLowerCase(); renderOrbs(); renderCollection(); };

</script>
</body>
</html>
